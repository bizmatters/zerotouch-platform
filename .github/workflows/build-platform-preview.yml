name: Build Platform Preview Image

on:
  push:
    branches: [main]
    paths:
      - 'platform/versions.yaml'
      - 'platform/docker/preview/**'
      - '.github/workflows/build-platform-preview.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/zerotouch-preview-node

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Extract Images
        id: extract
        run: |
          echo "Extracting images from platform/versions.yaml..."
          # Extract only from versions.yaml file
          cd platform
          # Extract all 'image' fields (including nested ones)
          yq '.. | select(has("image")) | .image' versions.yaml > ../images.txt
          # Also grab operator_image if present (special case for CNPG)
          yq '.. | select(has("operator_image")) | .operator_image' versions.yaml >> ../images.txt
          cd ..
          # Add hardcoded critical system images needed for Kind
          echo "docker.io/kindest/kindnetd:v20240813-c6f155d6" >> images.txt
          echo "docker.io/kindest/local-path-provisioner:v0.0.28" >> images.txt
          # Deduplicate and clean
          sort -u images.txt -o images.txt
          echo "Images to cache:"
          cat images.txt
          
          # Generate version tag from versions.yaml hash
          VERSION_HASH=$(sha256sum platform/versions.yaml | cut -d' ' -f1 | cut -c1-8)
          echo "version_tag=$VERSION_HASH" >> $GITHUB_OUTPUT
          echo "Image version tag: $VERSION_HASH"
      
      - name: Pull and Archive Images
        run: |
          mkdir -p platform/docker/preview
          echo "Pulling images..."
          # Pull images one by one, continue on failure
          while IFS= read -r img; do
            echo "Pulling $img..."
            docker pull "$img" || echo "Warning: Failed to pull $img, skipping..."
          done < images.txt
          # Get list of successfully pulled images
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -F -f images.txt > pulled-images.txt || true
          echo "Successfully pulled images:"
          cat pulled-images.txt
          # Save only successfully pulled images
          if [ -s pulled-images.txt ]; then
            echo "Saving images to tarball..."
            docker save -o platform/docker/preview/platform-images.tar $(cat pulled-images.txt | tr '\n' ' ')
            ls -lh platform/docker/preview/platform-images.tar
          else
            echo "Error: No images were successfully pulled"
            exit 1
          fi
          # Copy versions.yaml to Docker build context for CLI tool version extraction
          cp platform/versions.yaml platform/docker/preview/versions.yaml
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Multi-Arch
        uses: docker/build-push-action@v5
        with:
          context: platform/docker/preview
          file: platform/docker/preview/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.extract.outputs.version_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
