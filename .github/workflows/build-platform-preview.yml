name: Build Platform Preview Image

on:
  push:
    branches: [main]
    paths:
      - 'platform/versions.yaml'
      - 'platform/docker/preview/**'
      - '.github/workflows/build-platform-preview.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/zerotouch-preview-node

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Extract Images
        id: extract
        run: |
          echo "Extracting images from platform/versions.yaml..."
          # Extract all 'image' fields (including nested ones)
          yq '.. | select(has("image")) | .image' platform/versions.yaml > images.txt
          # Also grab operator_image if present (special case for CNPG)
          yq '.. | select(has("operator_image")) | .operator_image' platform/versions.yaml >> images.txt
          # Add hardcoded critical system images needed for Kind
          echo "docker.io/kindest/kindnetd:v20240813-c6f155d6" >> images.txt
          echo "docker.io/kindest/local-path-provisioner:v0.0.28" >> images.txt
          # Deduplicate and clean
          sort -u images.txt -o images.txt
          echo "Images to cache:"
          cat images.txt
      
      - name: Pull and Archive Images
        run: |
          mkdir -p platform/docker/preview
          echo "Pulling images..."
          xargs -n 1 docker pull < images.txt
          echo "Saving images to tarball..."
          docker save -o platform/docker/preview/platform-images.tar $(cat images.txt | tr '\n' ' ')
          ls -lh platform/docker/preview/platform-images.tar
      
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: platform/docker/preview
          file: platform/docker/preview/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
