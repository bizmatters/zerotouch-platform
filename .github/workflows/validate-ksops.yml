name: Validate KSOPS Integration

on:
  pull_request:
    paths:
      - 'platform/secrets/ksops/**'
      - 'scripts/bootstrap/infra/secrets/ksops/**'
      - 'scripts/bootstrap/validation/secrets/**'
      - 'scripts/bootstrap/validation/11-verify-ksops.sh'
      - '.github/workflows/validate-ksops.yml'
  workflow_dispatch:

jobs:
  validate-ksops:
    name: Validate KSOPS Integration
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Calculate Version Hash
        id: version
        run: |
          VERSION_HASH=$(sha256sum platform/versions.yaml | cut -d' ' -f1 | cut -c1-8)
          echo "hash=$VERSION_HASH" >> $GITHUB_OUTPUT
          echo "Using preview image version: $VERSION_HASH"

      - name: Setup Preview Environment
        env:
          KIND_NODE_IMAGE: ghcr.io/${{ github.repository_owner }}/zerotouch-preview-node:${{ steps.version.outputs.hash }}
        run: |
          # Use existing setup-preview.sh script (includes all CLI tools)
          ./scripts/bootstrap/preview/setup-preview.sh
          
          echo "Preview environment setup complete"

      - name: Install ArgoCD
        run: |
          # Use existing ArgoCD installation script
          ./scripts/bootstrap/install/09-install-argocd.sh preview
          
          echo "ArgoCD installation complete"

      - name: Setup KSOPS Tools and Keys
        run: |
          # Install tools only
          ./scripts/bootstrap/infra/secrets/ksops/08a-install-ksops.sh
          
          echo "KSOPS tools ready"

      - name: Inject Age Keys and Deploy KSOPS
        run: |
          # Generate keys and inject in same shell session to preserve environment variables
          echo "==> Step 1: Generating Age keys..."
          source ./scripts/bootstrap/infra/secrets/ksops/08b-generate-age-keys.sh
          
          echo "==> Step 2: Injecting Age keys..."
          ./scripts/bootstrap/infra/secrets/ksops/08c-inject-age-key.sh
          
          echo "==> Step 3: Deploying KSOPS package..."
          ./scripts/bootstrap/infra/secrets/ksops/08e-deploy-ksops-package.sh
          
          echo ""
          echo "==> Deployment Diagnostics"
          echo "Checking repo-server deployment..."
          kubectl get deployment argocd-repo-server -n argocd -o yaml | grep -A 20 "initContainers:" || echo "No initContainers found"
          
          echo ""
          echo "Checking repo-server pod status..."
          kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-repo-server -o wide
          
          echo ""
          echo "Checking init container logs..."
          POD_NAME=$(kubectl get pod -n argocd -l app.kubernetes.io/name=argocd-repo-server -o jsonpath='{.items[0].metadata.name}')
          echo "Pod: $POD_NAME"
          kubectl logs -n argocd $POD_NAME -c install-ksops 2>&1 || echo "Init container not found or not started"
          
          echo ""
          echo "Checking main container for KSOPS tools..."
          kubectl exec -n argocd $POD_NAME -c argocd-repo-server -- ls -la /usr/local/bin/ | grep -E "ksops|kustomize" || echo "Tools not found"
          
          echo ""
          echo "Checking environment variables..."
          kubectl exec -n argocd $POD_NAME -c argocd-repo-server -- env | grep -E "SOPS|XDG" || echo "Env vars not set"
          
          echo ""
          echo "Checking Age key mount..."
          kubectl exec -n argocd $POD_NAME -c argocd-repo-server -- ls -la /.config/sops/age/ 2>&1 || echo "Age key path not found"
          
          echo ""
          echo "KSOPS integration complete"

      - name: Run Master KSOPS Validation
        run: |
          # Use the master validation orchestrator
          ./scripts/bootstrap/validation/11-verify-ksops.sh
          
          echo "Master KSOPS validation complete"

      - name: Cleanup test resources
        if: always()
        run: |
          echo "Cleaning up test resources..."
          kubectl delete namespace test-ksops --ignore-not-found=true || true
          kubectl delete application test-ksops -n argocd --ignore-not-found=true || true

      - name: Summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ KSOPS Integration Validation Complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "All KSOPS validations passed successfully using orchestrated scripts!"
          echo ""