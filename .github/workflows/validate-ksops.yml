name: Validate KSOPS Integration

on:
  pull_request:
    paths:
      - 'platform/secrets/ksops/**'
      - 'scripts/bootstrap/infra/secrets/ksops/**'
      - 'scripts/bootstrap/validation/secrets/**'
      - 'scripts/bootstrap/validation/11-verify-ksops.sh'
      - '.github/workflows/validate-ksops.yml'
  workflow_dispatch:

jobs:
  validate-ksops:
    name: Validate KSOPS Integration
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Calculate Version Hash
        id: version
        run: |
          VERSION_HASH=$(sha256sum platform/versions.yaml | cut -d' ' -f1 | cut -c1-8)
          echo "hash=$VERSION_HASH" >> $GITHUB_OUTPUT
          echo "Using preview image version: $VERSION_HASH"

      - name: Setup Preview Environment
        env:
          KIND_NODE_IMAGE: ghcr.io/${{ github.repository_owner }}/zerotouch-preview-node:${{ steps.version.outputs.hash }}
        run: |
          # Use existing setup-preview.sh script (includes all CLI tools)
          ./scripts/bootstrap/preview/setup-preview.sh
          
          echo "Preview environment setup complete"

      - name: Install ArgoCD
        run: |
          # Use existing ArgoCD installation script
          ./scripts/bootstrap/install/09-install-argocd.sh preview
          
          echo "ArgoCD installation complete"

      - name: Setup KSOPS Tools and Keys
        run: |
          # Install tools only
          ./scripts/bootstrap/infra/secrets/ksops/08a-install-ksops.sh
          
          echo "KSOPS tools ready"

      - name: Inject Age Keys and Deploy KSOPS
        run: |
          # Generate keys and inject in same shell session to preserve environment variables
          source ./scripts/bootstrap/infra/secrets/ksops/08b-generate-age-keys.sh && \
          ./scripts/bootstrap/infra/secrets/ksops/08c-inject-age-key.sh && \
          ./scripts/bootstrap/infra/secrets/ksops/08e-deploy-ksops-package.sh
          
          echo "KSOPS integration complete"

      - name: Run Master KSOPS Validation
        run: |
          # Use the master validation orchestrator
          ./scripts/bootstrap/validation/11-verify-ksops.sh
          
          echo "Master KSOPS validation complete"

      - name: Cleanup test resources
        if: always()
        run: |
          echo "Cleaning up test resources..."
          kubectl delete namespace test-ksops --ignore-not-found=true || true
          kubectl delete application test-ksops -n argocd --ignore-not-found=true || true

      - name: Summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ KSOPS Integration Validation Complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "All KSOPS validations passed successfully using orchestrated scripts!"
          echo ""