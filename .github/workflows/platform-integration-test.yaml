name: Platform Integration Test

on:
  pull_request:
    paths:
      - 'platform/**'
      - 'bootstrap/**'
      - 'scripts/**'
  workflow_call:

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read

jobs:
  integration-test:
    name: Platform Integration Test
    runs-on: ubuntu-latest
    environment: preview
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ vars.AWS_ROLE_ARN }}
      #     aws-region: ap-south-1
      #     mask-aws-account-id: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Calculate Version Hash
        id: version
        run: |
          VERSION_HASH=$(sha256sum platform/versions.yaml | cut -d' ' -f1 | cut -c1-8)
          echo "hash=$VERSION_HASH" >> $GITHUB_OUTPUT
          echo "Using preview image version: $VERSION_HASH"

      - name: Generate .env from encrypted secrets
        env:
          ENV: pr
          SOPS_AGE_KEY: ${{ secrets.AGE_PRIVATE_KEY }}
        run: |
          if [ ! -f .env ]; then
            chmod +x scripts/bootstrap/infra/secrets/ksops/generate-sops/create-dot-env.sh
            ./scripts/bootstrap/infra/secrets/ksops/generate-sops/create-dot-env.sh
          fi

      - name: Bootstrap Platform Preview Environment
        env:
          # Kind configuration
          KIND_NODE_IMAGE: ghcr.io/${{ github.repository_owner }}/zerotouch-preview-node:${{ steps.version.outputs.hash }}
          
          # GitHub App variables (must be explicitly passed)
          GIT_APP_ID: ${{ vars.GIT_APP_ID }}
          GIT_APP_INSTALLATION_ID: ${{ vars.GIT_APP_INSTALLATION_ID }}
          
          # Note: All environment secrets (PR_HETZNER_*, GIT_APP_PRIVATE_KEY, BOT_GITHUB_TOKEN)
          # are automatically inherited from the 'preview' environment
        run: |
          chmod +x scripts/bootstrap/pipeline/02-master-bootstrap-v2.sh
          ./scripts/bootstrap/pipeline/02-master-bootstrap-v2.sh --mode preview

      - name: Wait for platform applications to sync
        run: |
          chmod +x scripts/bootstrap/wait/wait-for-sync.sh
          ./scripts/bootstrap/wait/wait-for-sync.sh --timeout 600

      - name: Wait for pods to be ready
        run: |
          chmod +x scripts/bootstrap/wait/wait-for-pods.sh
          ./scripts/bootstrap/wait/wait-for-pods.sh --timeout 600

      - name: Run cluster validation
        run: |
          chmod +x scripts/bootstrap/validation/99-validate-cluster.sh
          ./scripts/bootstrap/validation/99-validate-cluster.sh

      - name: Validate port-forwards
        run: |
          chmod +x scripts/bootstrap/validation/validate-port-forwards.sh
          ./scripts/bootstrap/validation/validate-port-forwards.sh --preview-mode --timeout 300

      - name: Show final cluster state
        if: always()
        run: |
          echo ""
          echo "=== Final Cluster State ==="
          echo ""
          echo "ArgoCD Applications:"
          kubectl get applications -n argocd || true
          echo ""
          echo "All Pods:"
          kubectl get pods -A || true
          echo ""
          echo "Nodes:"
          kubectl get nodes || true

      - name: Collect logs on failure
        if: failure()
        run: |
          echo ""
          echo "=== Collecting logs for debugging ==="
          echo ""
          
          echo "ArgoCD Application Controller logs:"
          kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller --tail=100 || true
          echo ""
          
          echo "External Secrets Operator logs:"
          kubectl logs -n external-secrets -l app.kubernetes.io/name=external-secrets --tail=100 || true
          echo ""
          
          echo "Failed pods:"
          kubectl get pods -A --field-selector=status.phase!=Running,status.phase!=Succeeded || true

      - name: Cleanup preview environment
        if: always()
        run: |
          chmod +x scripts/bootstrap/preview/cleanup-preview.sh
          ./scripts/bootstrap/preview/cleanup-preview.sh || true

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║          ✓ Platform Integration Test PASSED                 ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "All validations passed:"
          echo "  ✓ Platform bootstrapped in preview mode"
          echo "  ✓ All applications synced"
          echo "  ✓ All pods healthy"
          echo "  ✓ Cluster validation passed"
          echo ""
