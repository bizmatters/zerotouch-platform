name: CI Test

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'Container image tag to test'
        required: true
        type: string
      test_suite:
        description: 'Test suite path (e.g., tests/integration/nats_events)'
        required: true
        type: string
      test_name:
        description: 'Test name identifier'
        required: false
        type: string
        default: 'integration-test'
      timeout:
        description: 'Test timeout in minutes'
        required: false
        type: number
        default: 30
      use_real_llm:
        description: 'Whether to use real LLM APIs'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}
    steps:
      - name: Checkout Service Code
        uses: actions/checkout@v4
        with:
          path: service-code
          submodules: recursive
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Checkout Platform Scripts
        uses: actions/checkout@v4
        with:
          repository: arun4infra/zerotouch-platform
          path: zerotouch-platform
          ref: main
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1
          mask-aws-account-id: true

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Pull Test Image
        run: |
          echo "Pulling test image: ${{ inputs.image_tag }}"
          if [[ -z "${{ inputs.image_tag }}" ]]; then
            echo "âŒ ERROR: image_tag input is empty!"
            exit 1
          fi
          docker pull ${{ inputs.image_tag }}
          echo "âœ… Image pulled successfully"

      - name: Setup Test Environment
        working-directory: service-code
        run: |
          # Override image tag in ci/config.yaml for testing
          if [[ -f ci/config.yaml ]]; then
            # Extract image name from full tag
            IMAGE_NAME=$(echo "${{ inputs.image_tag }}" | cut -d':' -f1)
            IMAGE_TAG=$(echo "${{ inputs.image_tag }}" | cut -d':' -f2)
            
            # Update config to use the specific test image
            if command -v yq &> /dev/null; then
              yq eval ".build.image = \"${IMAGE_NAME}\"" -i ci/config.yaml
              yq eval ".build.tag = \"${IMAGE_TAG}\"" -i ci/config.yaml
            else
              echo "Warning: yq not available, using sed fallback"
              sed -i "s|tag:.*|tag: \"${IMAGE_TAG}\"|" ci/config.yaml
            fi
            
            echo "Updated ci/config.yaml to use test image: ${{ inputs.image_tag }}"
          fi

      - name: Run Integration Tests
        working-directory: service-code
        run: |
          # Export all secrets as environment variables
          echo '${{ toJSON(secrets) }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> "$GITHUB_ENV"
          
          # Export inputs as environment variables
          export TEST_PATH="${{ inputs.test_suite }}"
          export TEST_NAME="${{ inputs.test_name }}"
          export USE_REAL_LLM="${{ inputs.use_real_llm }}"
          export OVERRIDE_IMAGE_TAG="${{ inputs.image_tag }}"
          
          echo "ğŸ§ª Running test suite: ${{ inputs.test_suite }}"
          echo "ğŸ“¦ Using image: ${{ inputs.image_tag }}"
          echo "ğŸ·ï¸  Test name: ${{ inputs.test_name }}"
          
          # Make platform script executable
          chmod +x ../zerotouch-platform/scripts/bootstrap/preview/tenants/in-cluster-test.sh
          
          # Run the centralized test script
          ../zerotouch-platform/scripts/bootstrap/preview/tenants/in-cluster-test.sh