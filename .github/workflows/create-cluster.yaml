name: Create Cluster

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
        default: 'dev'
      skip_rescue_mode:
        description: 'Skip rescue mode (if already enabled)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      environment:
        description: 'Environment to bootstrap'
        required: true
        type: string
      skip_rescue_mode:
        description: 'Skip rescue mode (if already enabled)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write      # Required for OIDC
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 60
    env:
      CI: true
    
    steps:
      - name: Checkout platform repository
        uses: actions/checkout@v4

      - name: Setup Infrastructure Dependencies
        run: |
          chmod +x scripts/bootstrap/infra/00-setup-infra-deps.sh
          ./scripts/bootstrap/infra/00-setup-infra-deps.sh

      - name: Determine Age Key Secret Name
        id: age-key-name
        run: |
          ENV="${{ inputs.environment }}"
          case "$ENV" in
            production) echo "name=SOPS_AGE_KEY_PROD" >> $GITHUB_OUTPUT ;;
            pr) echo "name=SOPS_AGE_KEY_PR" >> $GITHUB_OUTPUT ;;
            dev) echo "name=SOPS_AGE_KEY_DEV" >> $GITHUB_OUTPUT ;;
            staging) echo "name=SOPS_AGE_KEY_STAGING" >> $GITHUB_OUTPUT ;;
            *) echo "name=SOPS_AGE_KEY_${ENV^^}" >> $GITHUB_OUTPUT ;;
          esac

      - name: Decrypt GitHub App credentials
        id: decrypt-creds
        uses: ./.github/actions/decrypt-github-app-creds
        with:
          environment: ${{ inputs.environment }}
          age-key: ${{ secrets[steps.age-key-name.outputs.name] }}

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ steps.decrypt-creds.outputs.app-id }}
          private-key: ${{ steps.decrypt-creds.outputs.private-key }}
          owner: ${{ github.repository_owner }}
          repositories: zerotouch-platform,zerotouch-tenants

      - name: Checkout tenants repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ vars.TENANTS_REPO_NAME }}
          token: ${{ steps.app-token.outputs.token }}
          path: .tenants-cache

      - name: Set tenant config path
        run: |
          echo "TENANT_CONFIG_FILE=${{ github.workspace }}/.tenants-cache/environments/${{ inputs.environment }}/talos-values.yaml" >> $GITHUB_ENV
          echo "TENANT_CACHE_DIR=${{ github.workspace }}/.tenants-cache" >> $GITHUB_ENV

      - name: Validate environment overlay
        run: |
          OVERLAY_DIR="bootstrap/argocd/overlays/main/${{ inputs.environment }}"
          if [ -d "$OVERLAY_DIR" ]; then
            echo "✓ Environment overlay found: $OVERLAY_DIR"
          else
            echo "✗ Environment overlay not found: $OVERLAY_DIR"
            ls -la bootstrap/argocd/overlays/main/
            exit 1
          fi

      - name: Setup environment
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          pip install pyyaml
          # Install yq v4 (the version that supports 'yq eval' syntax)
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          # Verify we have the right version
          /usr/local/bin/yq --version
          # Create symlink to ensure it's found
          sudo ln -sf /usr/local/bin/yq /usr/bin/yq
          # Install Talos CLI
          curl -sL https://talos.dev/install | sh
          # Find where talosctl was installed and move it to system path
          which talosctl || find $HOME -name "talosctl" -type f 2>/dev/null | head -1 | xargs -I {} sudo cp {} /usr/local/bin/
          # Verify installation
          talosctl version --client
          git config --global user.email "bootstrap@zerotouch.dev"
          git config --global user.name "ZeroTouch Bootstrap"

      - name: Decrypt secrets to .env
        env:
          ENV: ${{ inputs.environment }}
          AGE_PRIVATE_KEY: ${{ secrets[steps.age-key-name.outputs.name] }}
        run: |
          # Decrypt all secrets from Git to .env file
          # Provides credentials for rescue mode and bootstrap scripts
          ./scripts/bootstrap/infra/secrets/ksops/generate-sops/create-dot-env.sh

      - name: Enable Rescue Mode
        if: ${{ !inputs.skip_rescue_mode }}
        run: ./scripts/bootstrap/00-enable-rescue-mode.sh ${{ inputs.environment }} -y

      - name: Wait for rescue mode boot
        if: ${{ !inputs.skip_rescue_mode }}
        run: sleep 90

      - name: Bootstrap Cluster
        run: ./scripts/bootstrap/pipeline/02-master-bootstrap-v2.sh ${{ inputs.environment }}

      - name: Run Gateway Validation
        run: |
          echo "Running Gateway Validation..."
          echo "Validating agent gateway deployment and configuration..."
          GATEWAY_SCRIPT="./scripts/bootstrap/validation/agent-gateway/00-validate-agent-gateway.sh"
          if [ -f "$GATEWAY_SCRIPT" ]; then
            chmod +x "$GATEWAY_SCRIPT"
            "$GATEWAY_SCRIPT"
          else
            echo "❌ Gateway validation script not found: $GATEWAY_SCRIPT"
            exit 1
          fi

      - name: Run E2E Communication Tests
        run: |
          echo "Running E2E Communication Tests..."
          echo "Testing actual service communication and deployment..."
          E2E_SCRIPT="./scripts/bootstrap/validation/18-verify-e2e-communication.sh"
          if [ -f "$E2E_SCRIPT" ]; then
            chmod +x "$E2E_SCRIPT"
            "$E2E_SCRIPT"
          else
            echo "❌ E2E Communication test script not found: $E2E_SCRIPT"
            exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: "*.log"
          retention-days: 7
