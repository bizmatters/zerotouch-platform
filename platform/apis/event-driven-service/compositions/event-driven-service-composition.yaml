apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: event-driven-service
  labels:
    provider: kubernetes
    crossplane.io/xrd: xeventdrivenservices.platform.bizmatters.io
spec:
  compositeTypeRef:
    apiVersion: platform.bizmatters.io/v1alpha1
    kind: XEventDrivenService

  # Use Resources mode with standard patches (no custom function needed)
  mode: Resources
  publishConnectionDetailsWithStoreConfigRef:
    name: default
  resources:
          # Resource 1: ServiceAccount
          - name: serviceaccount
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                providerConfigRef:
                  name: kubernetes-provider
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: ServiceAccount
                    metadata:
                      name: placeholder
                      namespace: placeholder
                      labels:
                        app.kubernetes.io/name: placeholder
                        app.kubernetes.io/component: event-driven-worker
                        app.kubernetes.io/managed-by: crossplane
                    automountServiceAccountToken: false
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.labels[app.kubernetes.io/name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # Resource 2: Deployment
          - name: deployment
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                providerConfigRef:
                  name: kubernetes-provider
                forProvider:
                  manifest:
                    apiVersion: apps/v1
                    kind: Deployment
                    metadata:
                      name: placeholder
                      namespace: placeholder
                      labels:
                        app.kubernetes.io/name: placeholder
                        app.kubernetes.io/component: event-driven-worker
                        app.kubernetes.io/managed-by: crossplane
                    spec:
                      replicas: 1
                      selector:
                        matchLabels:
                          app.kubernetes.io/name: placeholder
                      template:
                        metadata:
                          labels:
                            app.kubernetes.io/name: placeholder
                            app.kubernetes.io/component: event-driven-worker
                            app.kubernetes.io/managed-by: crossplane
                            app.kubernetes.io/version: v1alpha1
                          annotations:
                            prometheus.io/scrape: "true"
                            prometheus.io/port: "8080"
                            prometheus.io/path: "/metrics"
                        spec:
                          serviceAccountName: placeholder
                          securityContext:
                            runAsNonRoot: true
                            runAsUser: 1000
                            fsGroup: 1000
                          containers:
                            - name: main
                              image: placeholder
                              imagePullPolicy: IfNotPresent
                              ports:
                                - name: http
                                  containerPort: 8080
                                  protocol: TCP
                              env:
                                - name: NATS_URL
                                  value: placeholder
                                - name: NATS_STREAM_NAME
                                  value: placeholder
                                - name: NATS_CONSUMER_GROUP
                                  value: placeholder
                                - name: PORT
                                  value: "8080"
                                - name: OTEL_SERVICE_NAME
                                  value: placeholder
                                - name: OTEL_SERVICE_VERSION
                                  value: "v1alpha1"
                                - name: OTEL_RESOURCE_ATTRIBUTES
                                  value: "service.name=placeholder,service.version=v1alpha1,deployment.environment=production"
                              envFrom:
                                - secretRef:
                                    name: placeholder-secret1
                                    optional: true
                                - secretRef:
                                    name: placeholder-secret2
                                    optional: true
                                - secretRef:
                                    name: placeholder-secret3
                                    optional: true
                                - secretRef:
                                    name: placeholder-secret4
                                    optional: true
                                - secretRef:
                                    name: placeholder-secret5
                                    optional: true
                              resources:
                                requests:
                                  cpu: "500m"
                                  memory: "1Gi"
                                limits:
                                  cpu: "2000m"
                                  memory: "4Gi"
                              securityContext:
                                runAsNonRoot: true
                                runAsUser: 1000
                                allowPrivilegeEscalation: false
                                capabilities:
                                  drop:
                                    - ALL
                                seccompProfile:
                                  type: RuntimeDefault
                              livenessProbe:
                                httpGet:
                                  path: /health
                                  port: 8080
                                initialDelaySeconds: 10
                                periodSeconds: 10
                                timeoutSeconds: 5
                                failureThreshold: 3
                              readinessProbe:
                                httpGet:
                                  path: /ready
                                  port: 8080
                                initialDelaySeconds: 5
                                periodSeconds: 5
                                timeoutSeconds: 3
                                failureThreshold: 2
            patches:
              # Patch name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
              # Patch labels
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.labels[app.kubernetes.io/name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.selector.matchLabels[app.kubernetes.io/name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.template.metadata.labels[app.kubernetes.io/name]
              # Patch ServiceAccount reference
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.serviceAccountName
              # Patch image
              - type: FromCompositeFieldPath
                fromFieldPath: spec.image
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].image
              # Note: imagePullPolicy defaults to IfNotPresent in base manifest
              # For :latest tags, users should explicitly set imagePullPolicy in their container runtime
              # Patch resource sizing based on size enum
              # CPU requests
              - type: FromCompositeFieldPath
                fromFieldPath: spec.size
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].resources.requests.cpu
                transforms:
                  - type: map
                    map:
                      micro: "100m"
                      small: "250m"
                      medium: "500m"
                      large: "1000m"
                policy:
                  fromFieldPath: Optional
              # CPU limits
              - type: FromCompositeFieldPath
                fromFieldPath: spec.size
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].resources.limits.cpu
                transforms:
                  - type: map
                    map:
                      micro: "500m"
                      small: "1000m"
                      medium: "2000m"
                      large: "4000m"
                policy:
                  fromFieldPath: Optional
              # Memory requests
              - type: FromCompositeFieldPath
                fromFieldPath: spec.size
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].resources.requests.memory
                transforms:
                  - type: map
                    map:
                      micro: "256Mi"
                      small: "512Mi"
                      medium: "1Gi"
                      large: "2Gi"
                policy:
                  fromFieldPath: Optional
              # Memory limits
              - type: FromCompositeFieldPath
                fromFieldPath: spec.size
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].resources.limits.memory
                transforms:
                  - type: map
                    map:
                      micro: "1Gi"
                      small: "2Gi"
                      medium: "4Gi"
                      large: "8Gi"
                policy:
                  fromFieldPath: Optional
              # Patch NATS environment variables
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nats.url
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[0].value
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nats.stream
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[1].value
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nats.consumer
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[2].value
              
              # Patch OpenTelemetry environment variables
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[4].value
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[6].value
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "service.name=%s,service.version=v1alpha1,deployment.environment=production"
              
              # Patch HTTP port (optional - defaults to 8080)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].ports[0].containerPort
                policy:
                  fromFieldPath: Optional
              
              # Patch PORT environment variable to match httpPort
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[3].value
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%d"
                policy:
                  fromFieldPath: Optional
              
              # Patch Prometheus port annotation to match httpPort
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.template.metadata.annotations[prometheus.io/port]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%d"
                policy:
                  fromFieldPath: Optional
              
              # Patch health check paths (optional - defaults to /health and /ready)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.healthPath
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].livenessProbe.httpGet.path
                policy:
                  fromFieldPath: Optional
              - type: FromCompositeFieldPath
                fromFieldPath: spec.readyPath
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].readinessProbe.httpGet.path
                policy:
                  fromFieldPath: Optional
              
              # Patch health check port to match httpPort (optional)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].livenessProbe.httpGet.port
                policy:
                  fromFieldPath: Optional
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].readinessProbe.httpGet.port
                policy:
                  fromFieldPath: Optional
              # Patch imagePullSecrets
              - type: FromCompositeFieldPath
                fromFieldPath: spec.imagePullSecrets
                toFieldPath: spec.forProvider.manifest.spec.template.spec.imagePullSecrets
                policy:
                  fromFieldPath: Optional

              # Patch secret slots (envFrom - bulk mounting)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.secret1Name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].envFrom[0].secretRef.name
                policy:
                  fromFieldPath: Optional

              - type: FromCompositeFieldPath
                fromFieldPath: spec.secret2Name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].envFrom[1].secretRef.name
                policy:
                  fromFieldPath: Optional

              - type: FromCompositeFieldPath
                fromFieldPath: spec.secret3Name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].envFrom[2].secretRef.name
                policy:
                  fromFieldPath: Optional

              - type: FromCompositeFieldPath
                fromFieldPath: spec.secret4Name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].envFrom[3].secretRef.name
                policy:
                  fromFieldPath: Optional

              - type: FromCompositeFieldPath
                fromFieldPath: spec.secret5Name
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].envFrom[4].secretRef.name
                policy:
                  fromFieldPath: Optional
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # Resource 3: Service
          - name: service
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                providerConfigRef:
                  name: kubernetes-provider
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Service
                    metadata:
                      name: placeholder
                      namespace: placeholder
                      labels:
                        app.kubernetes.io/name: placeholder
                        app.kubernetes.io/component: event-driven-worker
                        app.kubernetes.io/managed-by: crossplane
                        app.kubernetes.io/version: v1alpha1
                      annotations:
                        prometheus.io/scrape: "true"
                        prometheus.io/port: "8080"
                        prometheus.io/path: "/metrics"
                    spec:
                      type: ClusterIP
                      selector:
                        app.kubernetes.io/name: placeholder
                      ports:
                        - name: http
                          port: 8080
                          targetPort: http
                          protocol: TCP
            patches:
              # Patch name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
              # Patch labels
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.labels[app.kubernetes.io/name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.selector[app.kubernetes.io/name]
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # Resource 3a: HTTP Service (conditional - only when httpPort specified)
          - name: http-service
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                providerConfigRef:
                  name: kubernetes-provider
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Service
                    metadata:
                      name: placeholder-http
                      namespace: placeholder
                      labels:
                        app.kubernetes.io/name: placeholder
                        app.kubernetes.io/component: event-driven-worker
                        app.kubernetes.io/managed-by: crossplane
                        app.kubernetes.io/version: v1alpha1
                      annotations:
                        prometheus.io/scrape: "true"
                        prometheus.io/port: "8000"
                        prometheus.io/path: "/metrics"
                    spec:
                      type: ClusterIP
                      sessionAffinity: None
                      selector:
                        app.kubernetes.io/name: placeholder
                      ports:
                        - name: http
                          port: 8000
                          targetPort: http
                          protocol: TCP
            patches:
              # Only create if httpPort is specified
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.spec.ports[0].port
                policy:
                  fromFieldPath: Required
              # Patch name with -http suffix
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-http"
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
              # Patch labels
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.labels[app.kubernetes.io/name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.selector[app.kubernetes.io/name]
              # Patch session affinity
              - type: FromCompositeFieldPath
                fromFieldPath: spec.sessionAffinity
                toFieldPath: spec.forProvider.manifest.spec.sessionAffinity
                policy:
                  fromFieldPath: Optional
              # Patch Prometheus port annotation to match httpPort
              - type: FromCompositeFieldPath
                fromFieldPath: spec.httpPort
                toFieldPath: spec.forProvider.manifest.metadata.annotations[prometheus.io/port]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%d"
                policy:
                  fromFieldPath: Optional
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # Resource 4: KEDA ScaledObject
          - name: scaledobject
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                providerConfigRef:
                  name: kubernetes-provider
                forProvider:
                  manifest:
                    apiVersion: keda.sh/v1alpha1
                    kind: ScaledObject
                    metadata:
                      name: placeholder-scaler
                      namespace: placeholder
                      labels:
                        app.kubernetes.io/name: placeholder
                        app.kubernetes.io/component: event-driven-worker
                        app.kubernetes.io/managed-by: crossplane
                    spec:
                      scaleTargetRef:
                        name: placeholder
                      minReplicaCount: 1
                      maxReplicaCount: 10
                      cooldownPeriod: 30
                      pollingInterval: 5
                      triggers:
                        - type: nats-jetstream
                          metadata:
                            natsServerMonitoringEndpoint: "nats-headless.nats.svc.cluster.local:8222"
                            account: "$G"
                            stream: placeholder
                            consumer: placeholder
                            lagThreshold: "5"
                            activationLagThreshold: "0"
            patches:
              # Patch name (with -scaler suffix)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-scaler"
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
              # Patch labels
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.metadata.labels[app.kubernetes.io/name]
              # Patch scaleTargetRef to Deployment name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.claimRef.name
                toFieldPath: spec.forProvider.manifest.spec.scaleTargetRef.name
              # Patch NATS stream
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nats.stream
                toFieldPath: spec.forProvider.manifest.spec.triggers[0].metadata.stream
              # Patch NATS consumer
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nats.consumer
                toFieldPath: spec.forProvider.manifest.spec.triggers[0].metadata.consumer
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"


