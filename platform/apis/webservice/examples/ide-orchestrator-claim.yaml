# IDE Orchestrator WebService Claim
#
# Reference implementation for the deepagents-runtime integration project.
# This claim demonstrates the WebService XRD being used for IDE Orchestrator
# with database, external ingress, and deepagents-runtime integration.

apiVersion: platform.bizmatters.io/v1alpha1
kind: WebService
metadata:
  name: ide-orchestrator
  namespace: intelligence-deepagents
  annotations:
    argocd.argoproj.io/sync-wave: "1"  # Deploy after database
spec:
  # Container configuration
  image: "ghcr.io/org/ide-orchestrator:v1.0.0"
  port: 8080
  size: medium
  replicas: 2
  
  # Database configuration
  databaseName: "ide_orchestrator"
  databaseSize: medium
  
  # All secrets mounted via envFrom (bulk mounting)
  
  # Secret 1: PostgreSQL database credentials (auto-generated)
  # Created by: PostgresInstance claim (ide-orchestrator-db)
  # Keys mounted as env vars: endpoint, port, database, username, password
  # Application maps these to: POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD
  secret1Name: ide-orchestrator-db-conn
  
  # Secret 2: JWT signing keys (External Secrets Operator)
  # Keys: jwt_private_key, jwt_public_key, jwt_issuer, jwt_audience
  # Application uses these for WebSocket authentication and API security
  secret2Name: ide-orchestrator-jwt-keys
  
  # Secret 3: Application secrets (External Secrets Operator)
  # Keys: deepagents_runtime_url, cors_allowed_origins, log_level
  # Application configuration and integration settings
  secret3Name: ide-orchestrator-app-secrets
  
  # Image pull secrets for private registry
  imagePullSecrets:
    - name: ghcr-pull-secret
  
  # Init container for database migrations
  # Runs Go migrations before main container starts
  # Critical for schema updates during deployments
  initContainer:
    command: ["/bin/bash", "-c"]
    args:
      - |
        echo "Starting IDE Orchestrator database migrations..."
        cd /app && ./scripts/ci/run-migrations.sh
        echo "Migrations completed successfully"
  
  # External ingress configuration
  hostname: "api.bizmatters.com"
  pathPrefix: "/api"
  
  # Health check configuration
  healthPath: "/health"
  readyPath: "/ready"

# This creates:
# - ServiceAccount: ide-orchestrator
# - PostgresInstance: ide-orchestrator-db (medium size, auto-generates secret)
# - Deployment: ide-orchestrator (2 replicas, medium resources, init container)
# - Service: ide-orchestrator (ClusterIP, port 8080)
# - HTTPRoute: ide-orchestrator (external access via api.bizmatters.com/api)

# Integration with deepagents-runtime:
# - Internal communication: http://deepagents-runtime-service.intelligence-deepagents.svc:8000
# - WebSocket proxy: wss://api.bizmatters.com/api/ws/refinements/{thread_id}
# - REST API: https://api.bizmatters.com/api/workflows/{id}/refinements

# Environment Variables Available in Container:
# From secret1Name (database):
#   - endpoint → POSTGRES_HOST
#   - port → POSTGRES_PORT
#   - database → POSTGRES_DB
#   - username → POSTGRES_USER
#   - password → POSTGRES_PASSWORD
# From secret2Name (JWT):
#   - jwt_private_key → JWT_PRIVATE_KEY
#   - jwt_public_key → JWT_PUBLIC_KEY
#   - jwt_issuer → JWT_ISSUER
#   - jwt_audience → JWT_AUDIENCE
# From secret3Name (app):
#   - deepagents_runtime_url → DEEPAGENTS_RUNTIME_URL
#   - cors_allowed_origins → CORS_ALLOWED_ORIGINS
#   - log_level → LOG_LEVEL

# External Access:
# - HTTPS API: https://api.bizmatters.com/api
# - WebSocket: wss://api.bizmatters.com/api/ws/refinements/{thread_id}
# - Internal: http://ide-orchestrator.intelligence-deepagents.svc.cluster.local:8080

# Health Endpoints (implemented by IDE Orchestrator):
# - GET /health → 200 OK (liveness probe)
# - GET /ready → 200 OK if database, deepagents-runtime are reachable (readiness probe)

# API Endpoints (implemented by IDE Orchestrator):
# - POST /api/workflows/{id}/refinements → Initiate specification refinement
# - GET /api/proposals/{id} → Retrieve proposal details and generated files
# - POST /api/proposals/{id}/approve → Apply approved changes to drafts
# - POST /api/proposals/{id}/reject → Discard rejected proposals
# - WebSocket /api/ws/refinements/{thread_id} → Stream real-time updates

# Deployment Instructions:
# 1. Ensure all prerequisites exist (database, secrets, deepagents-runtime, Gateway)
# 2. Validate claim: ./scripts/validate-claim.sh ide-orchestrator-claim.yaml
# 3. Apply claim: kubectl apply -f ide-orchestrator-claim.yaml
# 4. Check status: kubectl get webservice ide-orchestrator -n intelligence-deepagents
# 5. Verify database: kubectl get postgresinstance ide-orchestrator-db -n intelligence-deepagents
# 6. Test external access: curl https://api.bizmatters.com/api/health

# Troubleshooting:
# - ImagePullBackOff: Check ghcr-pull-secret exists and is valid
# - CreateContainerConfigError: Check all 3 secrets exist (db-conn, jwt-keys, app-secrets)
# - Init:CrashLoopBackOff: Check database is reachable, migrations script is correct
# - HTTPRoute not working: Check cilium-gateway exists, DNS resolves to cluster
# - deepagents-runtime integration: Check deepagents-runtime service is running and accessible