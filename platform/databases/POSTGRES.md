# PostgreSQL (CNPG) - Zero-Touch Provisioning

## Overview

PostgreSQL databases are provisioned using CloudNative-PG (CNPG) via Crossplane with **zero-touch credential management**. No SSM, no ExternalSecrets, no manual passwords.

## Quick Start

Create a PostgresInstance claim - that's it:

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: my-service-db
  namespace: my-namespace
spec:
  size: medium    # small, medium, large
  version: "16"   # optional, default: "16"
  storageGB: 20   # optional, default: 20
```

**No credentials to manage. No secret name to specify.**

## Convention Over Configuration

The system uses **predictable naming conventions**:

| You Provide | System Creates |
|-------------|----------------|
| Claim: `my-service-db` | CNPG Cluster: `my-service-db` |
| | Database: `my-service-db` |
| | Owner: `my-service-db` |
| | Connection Secret: `my-service-db-conn` |

**Rule**: Connection secret name = `{claim-name}-conn`

## What Happens Automatically

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Zero-Touch Flow                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   1. You create PostgresInstance claim                              │
│      └─ name: my-service-db                                         │
│                           │                                          │
│                           ▼                                          │
│   2. Crossplane creates CNPG Cluster                                │
│      ├─ cluster: my-service-db                                      │
│      ├─ database: my-service-db                                     │
│      └─ owner: my-service-db                                        │
│                           │                                          │
│                           ▼                                          │
│   3. CNPG auto-generates password                                   │
│      └─ Creates: my-service-db-app secret (internal)                │
│                           │                                          │
│                           ▼                                          │
│   4. Crossplane copies credentials                                   │
│      └─ To: my-service-db-conn (your namespace)                     │
│                           │                                          │
│                           ▼                                          │
│   5. Your app reads from secret                                     │
│      └─ secretKeyRef: my-service-db-conn                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**No SSM. No ExternalSecrets. No manual passwords.**

## Connection Secret Format

The auto-created secret `{claim-name}-conn` contains:

| Key | Value |
|-----|-------|
| `endpoint` | `{claim-name}-rw.{namespace}.svc.cluster.local` |
| `port` | `5432` |
| `database` | Same as claim name |
| `username` | Same as claim name |
| `password` | Auto-generated by CNPG (64 chars) |

## Application Usage

Reference the connection secret in your deployment:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service
  namespace: my-namespace
spec:
  template:
    spec:
      containers:
        - name: app
          env:
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: my-service-db-conn  # {claim-name}-conn
                  key: endpoint
            - name: POSTGRES_PORT
              valueFrom:
                secretKeyRef:
                  name: my-service-db-conn
                  key: port
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: my-service-db-conn
                  key: database
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: my-service-db-conn
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: my-service-db-conn
                  key: password
```

## Size Options

| Size | Memory (request/limit) | CPU (request/limit) |
|------|------------------------|---------------------|
| small | 256Mi / 1Gi | 250m / 1000m |
| medium | 512Mi / 2Gi | 500m / 2000m |
| large | 1Gi / 4Gi | 1000m / 4000m |

## Complete Example: agent-executor

**Claim:**
```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: agent-executor-db
  namespace: intelligence-deepagents
spec:
  size: medium
  version: "16"
  storageGB: 20
```

**Result:**
- CNPG Cluster: `agent-executor-db`
- Database: `agent-executor-db`
- Owner: `agent-executor-db`
- Password: Auto-generated
- Connection Secret: `agent-executor-db-conn`
- Endpoint: `agent-executor-db-rw.intelligence-deepagents.svc.cluster.local`

**Deployment references:**
```yaml
secretKeyRef:
  name: agent-executor-db-conn  # Convention: {claim-name}-conn
  key: endpoint
```

## Migration from SSM-Based Pattern

If you have existing SSM-based PostgreSQL:

1. **Simplify claim** - Remove `writeConnectionSecretToRef`, `databaseName`, `databaseOwner`, `credentialsSecretName`
2. **Remove ExternalSecret** - Delete `db-credentials-es.yaml`
3. **Update deployment** - Change secret reference to `{claim-name}-conn`
4. **Delete SSM parameters** - Optional cleanup

⚠️ The cluster will be recreated with new auto-generated credentials.

## Troubleshooting

### Claim stuck in "Creating"
Check if the CNPG cluster is ready:
```bash
kubectl get cluster <claim-name> -n <namespace>
```

### Connection secret not created
Verify the CNPG `-app` secret exists:
```bash
kubectl get secret <claim-name>-app -n <namespace>
```

### Check secret contents
```bash
kubectl get secret <claim-name>-conn -n <namespace> -o jsonpath='{.data}' | \
  python3 -c "import sys,json,base64; d=json.load(sys.stdin); print({k:base64.b64decode(v).decode() for k,v in d.items()})"
```

### Database not accessible
Verify endpoint is correct:
```bash
kubectl get secret <claim-name>-conn -n <namespace> -o jsonpath='{.data.endpoint}' | base64 -d
```
