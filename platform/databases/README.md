# Database Layer - Crossplane XRDs & Compositions

This ArgoCD Application manages **cluster-scoped** Crossplane database definitions.

## Zero-Touch Database Provisioning

Databases are provisioned with **zero-touch credential management**:
- No SSM parameters
- No ExternalSecrets
- No manual passwords
- Credentials auto-generated and delivered to your namespace

See [POSTGRES.md](POSTGRES.md) and [DRAGONFLY.md](DRAGONFLY.md) for details.

## Structure

```
platform/databases/
├── definitions/                # XRDs (cluster-scoped API definitions)
│   ├── postgres-xrd.yaml
│   └── dragonfly-xrd.yaml
├── compositions/               # Compositions (cluster-scoped provisioning logic)
│   ├── postgres-composition.yaml
│   └── dragonfly-composition.yaml
├── POSTGRES.md                 # PostgreSQL documentation
├── DRAGONFLY.md                # Dragonfly documentation
└── README.md                   # This file
```

## Quick Start

### PostgreSQL (Zero-Touch)

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: my-service-db
  namespace: my-namespace
spec:
  size: medium      # small, medium, large
  version: "16"     # optional
  storageGB: 20     # optional
```

**Result:**
- CNPG Cluster: `my-service-db`
- Connection Secret: `my-service-db-conn` (auto-created)
- Password: Auto-generated by CNPG

### Dragonfly (Zero-Touch)

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: DragonflyInstance
metadata:
  name: my-cache
  namespace: my-namespace
spec:
  size: small       # small, medium, large
  storageGB: 10     # optional
```

**Result:**
- Dragonfly StatefulSet: `my-cache`
- Connection Secret: `my-cache-conn` (auto-created)
- Password: Auto-generated

## Convention Over Configuration

Both databases follow the same naming convention:

| You Provide | System Creates |
|-------------|----------------|
| Claim: `my-service-db` | Connection Secret: `my-service-db-conn` |
| Claim: `my-cache` | Connection Secret: `my-cache-conn` |

**Rule**: Secret name = `{claim-name}-conn`

No `connectionSecretName` needed - it's auto-derived!

## Connection Secrets

### PostgreSQL (`{claim-name}-conn`)

| Key | Value |
|-----|-------|
| `endpoint` | `{claim-name}-rw.{namespace}.svc.cluster.local` |
| `port` | `5432` |
| `database` | Same as claim name |
| `username` | Same as claim name |
| `password` | Auto-generated (64 chars) |

### Dragonfly (`{claim-name}-conn`)

| Key | Value |
|-----|-------|
| `endpoint` | `{claim-name}.{namespace}.svc.cluster.local` |
| `port` | `6379` |
| `password` | Auto-generated (UUID) |

## Size Mappings

### PostgreSQL

| Size | Memory | CPU |
|------|--------|-----|
| small | 256Mi-1Gi | 250m-1000m |
| medium | 512Mi-2Gi | 500m-2000m |
| large | 1Gi-4Gi | 1000m-4000m |

### Dragonfly

| Size | Memory | CPU |
|------|--------|-----|
| small | 512Mi-2Gi | 250m-1000m |
| medium | 1Gi-4Gi | 500m-2000m |
| large | 2Gi-8Gi | 1000m-4000m |

## Application Usage

### PostgreSQL
```yaml
env:
  - name: POSTGRES_HOST
    valueFrom:
      secretKeyRef:
        name: my-service-db-conn  # {claim-name}-conn
        key: endpoint
  - name: POSTGRES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: my-service-db-conn
        key: password
```

### Dragonfly
```yaml
env:
  - name: REDIS_HOST
    valueFrom:
      secretKeyRef:
        name: my-cache-conn  # {claim-name}-conn
        key: endpoint
  - name: REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: my-cache-conn
        key: password
```

## Architecture

```
Developer creates claim          Crossplane provisions
─────────────────────────────────────────────────────────────
PostgresInstance                 → CNPG Cluster
  name: my-db                      name: my-db
  namespace: my-ns                 namespace: my-ns
  spec:                          
    size: medium                 → Secret: my-db-conn
                                   (auto-generated credentials)

DragonflyInstance                → StatefulSet + Service
  name: my-cache                   name: my-cache
  namespace: my-ns                 namespace: my-ns
  spec:                          
    size: small                  → Secret: my-cache-conn
                                   (auto-generated credentials)
```

## What This Deploys

- **CompositeResourceDefinitions (XRDs)**: Define the API
- **Compositions**: Define how to provision databases

## What This Does NOT Deploy

- ❌ No database instances (claims live with applications)
- ❌ No secrets (auto-created by compositions)
- ❌ No SSM parameters (zero-touch pattern)
