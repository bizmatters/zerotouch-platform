apiVersion: v1
kind: ConfigMap
metadata:
  name: agentgateway-config
  namespace: platform-agent-gateway
data:
  config.yaml: |
    # AgentGateway Configuration for Platform Authentication
    # Corrected schema structure for agentgateway binary compatibility

    binds:
      - port: 3000
        listeners:
          - name: main-listener
            protocol: HTTP
            routes:
              # 0. Health Check
              - name: health
                matches:
                  - path: 
                      exact: "/health"
                policies:
                  directResponse:
                    status: 200
                    body: "OK"

              # 1. Login Routes (Passthrough to Identity Service)
              - name: auth
                matches:
                  - path: 
                      pathPrefix: "/auth"
                backends:
                  - host: "identity-service.platform-identity.svc.cluster.local:3000"

              # 2. API Routes (Protected via Sidecar Authorizer)
              - name: api
                matches:
                  - path: 
                      pathPrefix: "/api"
                policies:
                  extAuthz:
                    host: "identity-service.platform-identity.svc.cluster.local:3000"
                    timeout: "1s"
                    includeRequestHeaders:
                      - cookie
                      - authorization
                    protocol:
                      http:
                        path: '"/internal/validate"'
                        addRequestHeaders:
                          x-forwarded-host: request.host
                        includeResponseHeaders:
                          - Authorization
                          - X-Auth-User-Id
                          - X-Auth-Org-Id
                          - X-Auth-Role
                  requestHeaderModifier:
                    remove: ["Cookie"]
                backends:
                  - host: "ide-orchestrator.intelligence-orchestrator.svc.cluster.local:8080"