FROM kindest/node:v1.31.0

# Install yq for version extraction
RUN curl -L "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" -o /usr/local/bin/yq && \
    chmod +x /usr/local/bin/yq

# Copy versions.yaml to extract CLI tool versions
COPY versions.yaml /tmp/versions.yaml

# Extract versions and install CLI tools
RUN KUBECTL_VERSION=$(yq '.components.cli_tools.kubectl' /tmp/versions.yaml) && \
    HELM_VERSION=$(yq '.components.cli_tools.helm' /tmp/versions.yaml) && \
    SOPS_VERSION=$(yq '.components.cli_tools.sops' /tmp/versions.yaml) && \
    AGE_VERSION=$(yq '.components.cli_tools.age' /tmp/versions.yaml) && \
    ARGOCD_VERSION=$(yq '.components.cli_tools.argocd' /tmp/versions.yaml) && \
    \
    # Install kubectl
    curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/kubectl && \
    \
    # Install helm
    curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
    chmod 700 get_helm.sh && \
    DESIRED_VERSION=${HELM_VERSION} ./get_helm.sh && \
    rm get_helm.sh && \
    \
    # Install SOPS
    curl -LO "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" && \
    chmod +x "sops-${SOPS_VERSION}.linux.amd64" && \
    mv "sops-${SOPS_VERSION}.linux.amd64" /usr/local/bin/sops && \
    \
    # Install Age
    curl -LO "https://github.com/FiloSottile/age/releases/download/${AGE_VERSION}/age-${AGE_VERSION}-linux-amd64.tar.gz" && \
    tar xzf "age-${AGE_VERSION}-linux-amd64.tar.gz" && \
    mv age/age /usr/local/bin/ && \
    mv age/age-keygen /usr/local/bin/ && \
    rm -rf age "age-${AGE_VERSION}-linux-amd64.tar.gz" && \
    \
    # Install ArgoCD CLI
    curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64" && \
    chmod +x argocd && \
    mv argocd /usr/local/bin/argocd && \
    \
    # Cleanup
    rm /tmp/versions.yaml

# 1. Setup the preload directory
RUN mkdir -p /var/lib/zerotouch

# 2. Copy the systemd logic
COPY import-images.sh /usr/local/bin/import-images.sh
COPY import-images.service /etc/systemd/system/import-images.service

# 3. Enable the service
RUN chmod +x /usr/local/bin/import-images.sh && \
    systemctl enable import-images.service

# 4. Copy the heavy archive
# NOTE: This file is expected to be generated by the CI workflow BEFORE build
COPY platform-images.tar /var/lib/zerotouch/platform-images.tar

LABEL description="ZeroTouch Preview Node - Pre-cached with CLI Tools and Systemd Import"
